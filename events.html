<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>EventEmitter Demo</title>
    <link rel="stylesheet" href="demos.css" />
</head>

<body>
    <div id="info">
        <strong>EventEmitter Demo</strong> — Shows how <code>Game.events</code> handles unified input events. <br>
        Events from <strong>mouse</strong>, <strong>touch</strong>, <strong>keyboard</strong> and <strong>input</strong>
        are emitted using a
        single system. <br>
        This demo logs the last event that happened inside a box on screen. Try clicking, moving, or touching!
    </div>

    <canvas id="game"></canvas>

    <script type="module">
        import { Game, Scene, GameObject, FPSCounter, Rectangle, TextShape, Group, Keys } from "/gcanvas.es.min.js";

        class EventLogger extends GameObject {
            constructor(game, options = {}) {
                super(game, options);
                this.interactive = true;
                console.groupCollapsed("EventLoggerText");
                this.label = new TextShape("Waiting for event...", {
                    font: "16px monospace",
                    color: "#0f0",
                    align: "center",
                    baseline: "middle",
                    debug: false,
                    name: "EventLoggerText"
                });
                console.groupEnd();
                console.groupCollapsed("EventLoggerBox");

                this.box = new Rectangle({
                    width: 280,
                    height: 80,
                    color: "#111",
                    debug: true
                });
                console.groupEnd();
                console.groupCollapsed("EventLoggerGroup");

                this.group = new Group({ width: 280, height: 80 });
                this.group.add(this.box);
                this.group.add(this.label);
                console.groupEnd();
                const events = ["wheel", "inputdown", "inputup", "inputmove", "click"];

                const groupEvents = [
                    "mouseover", "mouseout", "click", "touchstart", "touchend", "touchmove",
                    "inputdown", "inputup", "inputmove"
                ];

                let lock = false;
                var inside = false;

                events.forEach(type => {
                    this.game.events.on(type, (e) => {
                        if (!lock && !inside) {
                            this.label.text = `Ouside the Box: ${type}`;
                        }
                    });
                });

                const unlockAfterTimeout = (time) => {
                    setTimeout(() => {
                        lock = false;
                    }, time);
                };

                groupEvents.forEach(type => {
                    this.on(type, (e) => {
                        if (!lock) {
                            this.label.text = `Inside the Box: ${type}`;
                        }
                        if (type == "mouseout" || type == "mouseover") {
                            lock = true;
                            unlockAfterTimeout(1000);
                        }
                        if (type == "mouseout") {
                            inside = false;
                        } else if (type == "mouseover") {
                            inside = true;
                        }
                    });
                });
                //
                //
                /**
                 * Log Keys. We'll listen for key down events on some set of logical keys
                 * and do exactly the same inside/outside labeling. We also handle “_up” suffix.
                 */
                const keyList = [
                    Keys.W, Keys.A, Keys.S, Keys.D,
                    Keys.UP, Keys.DOWN, Keys.LEFT, Keys.RIGHT,
                    Keys.SPACE, Keys.SHIFT, Keys.ENTER, Keys.ESC,
                    "keyup", "keydown"
                ];

                keyList.forEach(logicalKey => {
                    // Key down event => just “logicalKey” 
                    this.game.events.on(logicalKey, (e) => {
                        if (!lock) {
                            if (e.type == "keydown") {
                                // Only log if key is NOT one of the logical keys in keyList
                                if (keyList.indexOf(e.key) == -1) {
                                    this.label.text = `KeyDown ${e.key}`;
                                }
                            } else {
                                this.label.text = `KeyDown ${logicalKey}`;
                            }
                        }
                    });
                    // Key up event => “logicalKey + "_up” 
                    this.game.events.on(logicalKey + "_up", (e) => {
                        if (!lock) {
                            if (e.type == "keyup") {
                                // Only log if key is NOT one of the logical keys in keyList
                                if (keyList.indexOf(e.key) == -1) {
                                    this.label.text = `KeyUp ${e.key}`;
                                    return;
                                }
                            }
                            this.label.text = `KeyUp ${logicalKey}`;
                        }
                    });
                });
            }
            draw() {
                super.draw();
                this.logger.log("draw", this.x, this.y, this.width, this.height);
                this.group.render();
            }
        }

        class EventDemoGame extends Game {
            constructor(canvas) {
                super(canvas);
                this.enableFluidSize();
                this.backgroundColor = "black";
            }

            init() {
                super.init();
                console.groupCollapsed("init");
                this.scene = new Scene(this, { name: "EventDemoScene", width: 280, height: 80 });
                this.ui = new Scene(this);
                this.pipeline.add(this.scene);
                this.pipeline.add(this.ui);
                console.groupEnd();
                console.groupCollapsed("add EventLogger");
                this.scene.add(new EventLogger(this, { width: 280, height: 80 }));
                console.groupEnd();
                console.groupCollapsed("add FPSCounter");
                this.ui.add(new FPSCounter(this, { anchor: "bottom-right" }));
                console.groupEnd();
            }

            update(dt) {
                this.scene.x = this.width / 2;
                this.scene.y = this.height / 2;
                this.ui.width = this.width;
                this.ui.height = this.height;
                super.update(dt);
            }

            clear() {
                this.ctx.fillStyle = "black";
                this.ctx.fillRect(0, 0, this.width, this.height);
            }
        }

        window.addEventListener("load", () => {
            const canvas = document.getElementById("game");
            const game = new EventDemoGame(canvas);
            //            game.enableLogging();

            game.setFPS(60);
            game.start();
            /* setTimeout(() => {
                game.stop();
            }, 10000); */
        });
    </script>
</body>

</html>